# Отчёт по практической работе №6
## Работа с Фрагментами в Android

### **Цель работы**

Целью данной практической работы являлось изучение и практическое освоение фундаментального компонента Android — **Фрагментов (`Fragment`)**. Основные задачи включали:

-   **Изучение жизненного цикла Фрагмента:** Понимание основных методов жизненного цикла и их связи с `Activity`.
-   **Освоение `FragmentManager`:** Получение навыков динамического управления фрагментами — добавление, замена и использование `Back Stack`.
-   **Изучение способов коммуникации между фрагментами:** Практическая реализация обмена данными с использованием `Shared ViewModel` и `Fragment Result API`.
-   **Рефакторинг проекта на Single-Activity Architecture:** В рамках контрольного задания требовалось перестроить основной проект "PocketDictionary" на архитектуру с одной `Activity`, управляющей несколькими фрагментами.

### **FragmentApp**

Было создано приложение, которое отображает список дел с сервера `jsonplaceholder.typicode.com`. Вся логика, включая `RecyclerView` и `Retrofit`, была инкапсулирована внутри `TodoListFragment`. 
```java
@Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
        super.onViewCreated(view, savedInstanceState);

        recyclerView = view.findViewById(R.id.recyclerView);
        recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));

        Retrofit retrofit = new Retrofit.Builder()
                .baseUrl(BASE_URL)
                .client(getUnsafeOkHttpClient())
                .addConverterFactory(GsonConverterFactory.create())
                .build();

        apiService = retrofit.create(ApiService.class);
        loadTodos();
    }
```
Дополнительно, была реализована передача стартовых данных (номера по списку) из `MainActivity` во фрагмент с помощью `Bundle` и `setArguments()`.
```java
@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        if (savedInstanceState == null) {
            Bundle bundle = new Bundle();
            bundle.putInt("student_number", MY_STUDENT_NUMBER);

            TodoListFragment todoListFragment = new TodoListFragment();
            todoListFragment.setArguments(bundle);

            getSupportFragmentManager().beginTransaction()
                    .setReorderingAllowed(true)
                    .add(R.id.fragment_container_view, todoListFragment)
                    .commit();
        }
    }
```
В ходе работы была решена проблема с SSL-сертификатами на эмуляторе путем создания `OkHttpClient`.

<img width="400" height="800" alt="image" src="https://github.com/user-attachments/assets/00bcb2df-f8bd-42fc-ba0f-db0ec7091eb2" />


### **FragmentManagerApp**

Было создано приложение с `FragmentManagerApp`. 
Созданы два фрагмента:
- `CountryListFragment`, содержащий `ListView со статичным списком стран.
- `CountryDetailsFragment`, содержащий `TextView` с текстом-заглушкой "Выберите страну из списка".
Модифицирован макет activity_main.xml: вместо одного контейнера были размещены два `FragmentContainerView` в `LinearLayout` с вертикальной ориентацией.

<img width="450" height="350" alt="image" src="https://github.com/user-attachments/assets/e07036f5-948a-4183-a18f-59173f3e0d7f" />

Реализовано динамическое добавление - в `MainActivity`, в методе `onCreate`, с помощью `FragmentManager` была создана транзакция, которая одновременно добавляет оба фрагмента в соответствующие контейнеры.
```java
@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        if (savedInstanceState == null) {
            getSupportFragmentManager().beginTransaction()
                    .setReorderingAllowed(true)
                    .add(R.id.list_container, new CountryListFragment())
                    .add(R.id.details_container, new CountryDetailsFragment())
                    .commit();
        }
    }
```

<img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/c7d76839-9cc1-4c29-8ba2-df5e9ef3325b" />

### Передача данных через `Shared ViewModel`
- В этом же модуле оздан класс `SharedViewModel`, унаследованный от `ViewModel`. В него была добавлена `LiveData` для хранения имени выбранной страны, а также Map с детальными описаниями для каждой страны.
- Модифицирован `CountryListFragment`: в фрагмент была добавлена логика получения `SharedViewModel` с областью видимости Activity.
На `ListView` был установлен слушатель `OnItemClickListener`, который при нажатии на элемент вызывает метод select() в `SharedViewModel`, передавая в него имя выбранной страны.
```java
@Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
        View view = inflater.inflate(R.layout.fragment_country_list, container, false);
        ListView listView = view.findViewById(R.id.listViewCountries);
        ArrayAdapter<String> adapter = new ArrayAdapter<>(getContext(),
                android.R.layout.simple_list_item_1, countries);
        listView.setAdapter(adapter);

        listView.setOnItemClickListener((parent, view1, position, id) -> {
            String selectedCountry = countries[position];
            sharedViewModel.select(selectedCountry);
        });

        return view;
    }
```
- Модифицирован `CountryDetailsFragment`: этот фрагмент также получил доступ к тому же экземпляру `SharedViewModel`. 
В методе `onViewCreated` была создана подписка на `LiveData` из `ViewModel`.
```java
@Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
        super.onViewCreated(view, savedInstanceState);
        
        sharedViewModel.getSelected().observe(getViewLifecycleOwner(), countryName -> {

            String description = sharedViewModel.getDescription(countryName);

            if (description != null) {
                detailsTextView.setText(description);
            } else {
                detailsTextView.setText("Описание для \"" + countryName + "\" не найдено.");
            }
        });
    }
```
При получении нового имени страны, фрагмент запрашивал у `ViewModel` полное описание и обновлял им свой `TextView`.

<img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/a0ec1ebc-86b1-4dfe-8d67-066937354c7d" /> <img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/6177a1d3-8efb-4dff-ad02-d098e69a5872" />

### ResultApiFragmentApp

Было создано приложение для изучения `Fragment Result API`. 
- `DataFragment` по нажатию на кнопку открывает `BottomSheetDialogFragment`.
```java
openButton.setOnClickListener(v -> {
            new BottomSheetFragment().show(getParentFragmentManager(), "BottomSheetFragment");
        });
```
- Пользователь вводит текст в `BottomSheet`, который затем, используя `setFragmentResult()`, отправляет данные обратно.
```java
sendButton.setOnClickListener(v -> {
            String text = editText.getText().toString();

            Bundle result = new Bundle();
            result.putString("bundleKey", text);

            getParentFragmentManager().setFragmentResult("requestKey", result);

            dismiss();
        });
```
- `DataFragment`, в свою очередь, получает этот результат с помощью `setFragmentResultListener()` и обновляет свой `TextView`.
```java
getParentFragmentManager().setFragmentResultListener("requestKey", this, (requestKey, bundle) -> {
            String result = bundle.getString("bundleKey");
            textViewResult.setText("Полученный результат: " + result);
        });
```
<img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/0860c5d8-715b-482d-8436-4cfe1aefa286" /> <img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/6a95cf70-4d99-490b-af67-363c2c2b36ce" />
<img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/9858590a-085c-4b62-851d-424fd889975b" /> <img width="200" height="450" alt="image" src="https://github.com/user-attachments/assets/cb8e2419-c584-4a8f-a4f8-e8bfaeab64c2" />

### **Контрольное задание**

Финальное задание заключалось в полном рефакторинге проекта `PocketDictionary` на **Single-Activity Architecture**.

1.  **`MainActivity` преобразована в хост:** `MainActivity` была полностью очищена от UI-логики. Ее макет теперь содержит только `FragmentContainerView` для отображения фрагментов и `BottomNavigationView` для навигации.
2.  **Созданы основные фрагменты:**
    *   **`SearchFragment`:** Вся логика и UI (поиск, результат, `ViewModel`) из старой `MainActivity` были перенесены в этот фрагмент.
    *   **`FavoritesFragment`:** Вся логика и UI (список `RecyclerView`, `ViewModel`) из старой `FavoritesActivity` были перенесены в этот фрагмент. `FavoritesActivity` была удалена из проекта.
    *   **`ProfileFragment`:** Был создан новый фрагмент, отображающий email текущего пользователя (из `Firebase`) и содержащий кнопку "Выход".

<img width="325" height="250" alt="image" src="https://github.com/user-attachments/assets/0f77c19a-5d5e-455d-a3d0-c49e099f9fcc" /> <img width="325" height="250" alt="image" src="https://github.com/user-attachments/assets/bfd595ff-51d2-4b86-b5ee-0ed1a8d67e75" />

    
3.  **Реализована навигация:** В `MainActivity` настроен `OnItemSelectedListener` для `BottomNavigationView`, который заменяет фрагменты в контейнере.

```java
bottomNav.setOnItemSelectedListener(item -> {
            Fragment selectedFragment = null;
            String tag = null;
            int itemId = item.getItemId();

            if (itemId == R.id.navigation_search) {
                selectedFragment = new SearchFragment();
                tag = "SEARCH_FRAGMENT";
            } else if (itemId == R.id.navigation_favorites) {
                selectedFragment = new FavoritesFragment();
                tag = "FAVORITES_FRAGMENT";
            } else if (itemId == R.id.navigation_profile) {
                selectedFragment = new ProfileFragment();
                tag = "PROFILE_FRAGMENT";
            }
```
4.  **Реализован `Back Stack`:** транзакции замены фрагментов добавляются в бэк-стек с помощью `.addToBackStack()`.

```java
if (selectedFragment != null) {
                getSupportFragmentManager().beginTransaction()
                        .replace(R.id.fragment_container_view, selectedFragment, tag)
                        .addToBackStack(tag)
                        .commit();
            }
            return true;
```
5.  Было реализовано кастомное поведение системной кнопки "Назад" через `OnBackPressedDispatcher`, которое позволяет перемещаться по истории открытых фрагментов и обновляет состояние `BottomNavigationView`.

```java
getOnBackPressedDispatcher().addCallback(this, new OnBackPressedCallback(true) {
            @Override
            public void handleOnBackPressed() {
                FragmentManager fm = getSupportFragmentManager();
                if (fm.getBackStackEntryCount() > 0) {
                    fm.popBackStack();

                    fm.addOnBackStackChangedListener(new FragmentManager.OnBackStackChangedListener() {
                        @Override
                        public void onBackStackChanged() {
                            Fragment currentFragment = fm.findFragmentById(R.id.fragment_container_view);
                            if (currentFragment instanceof SearchFragment) {
                                bottomNav.setSelectedItemId(R.id.navigation_search);
                            } else if (currentFragment instanceof FavoritesFragment) {
                                bottomNav.setSelectedItemId(R.id.navigation_favorites);
                            } else if (currentFragment instanceof ProfileFragment) {
                                bottomNav.setSelectedItemId(R.id.navigation_profile);
                            }
                            fm.removeOnBackStackChangedListener(this);
                        }
                    });
                } else {
                    finish();
                }
            }
        });
```

<img width="300" height="750" alt="image" src="https://github.com/user-attachments/assets/ef25033b-c583-4e6b-9efa-7cb0b46dd247" /> <img width="300" height="750" alt="image" src="https://github.com/user-attachments/assets/45a00ea1-4f5c-469d-ace7-e8c40ca7b507" />
<img width="300" height="750" alt="image" src="https://github.com/user-attachments/assets/3bbdb4cb-5ecb-4993-b732-201c2d7109e2" />




